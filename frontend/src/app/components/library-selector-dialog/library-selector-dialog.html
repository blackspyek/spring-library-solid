<div class="bg-[color:var(--white-to-yellow)] p-6 w-[850px] max-w-[90vw] box-border">
  @if (showSuccess()) {
    <div class="flex flex-col items-center justify-center min-h-[400px]">
      <mat-icon class="text-6xl text-green-500 mb-4">check_circle</mat-icon>
      <h3 class="text-xl font-semibold mb-2 text-[color:var(--base-gray-darker-catalog)]">
        Rezerwacja złożona pomyślnie!
      </h3>
      <p class="text-base font-medium text-[color:var(--base-gray-darker-catalog)] mb-2">
        „{{ data.bookTitle }}"
      </p>
      <p class="text-sm text-[color:var(--base-gray-darker-catalog)] mb-4">
        {{ getSelectedBranchName() }}
      </p>
      <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-6 text-center">
        <p class="text-sm text-amber-800">
          <mat-icon class="text-amber-600 align-middle mr-1" style="font-size: 18px; width: 18px; height: 18px;">
            schedule
          </mat-icon>
          Odbierz książkę do: <span class="font-bold">{{ reservationExpiresAt() | date: 'dd.MM.yyyy HH:mm' }}</span>
        </p>
        <p class="text-xs text-amber-700 mt-1">
          Po tym terminie rezerwacja zostanie automatycznie anulowana.
        </p>
      </div>
      <button
        mat-flat-button
        (click)="closeSuccess()"
        class="!px-8 !py-2 !font-medium !rounded-md cursor-pointer !bg-[color:var(--edit-button-bg)] !text-white"
      >
        ZAMKNIJ
      </button>
    </div>
  } @else if (showConfirmation()) {
    <div class="flex flex-col items-center justify-center min-h-[400px]">
      @if (isLoading()) {
        <mat-spinner diameter="48" class="mb-4"></mat-spinner>
        <p class="text-lg text-[color:var(--base-gray-darker-catalog)]">Rezerwuję książkę...</p>
      } @else {
        <mat-icon class="text-6xl text-[color:var(--edit-button-bg)] mb-4">help_outline</mat-icon>
        <h3 class="text-xl font-semibold mb-2 text-[color:var(--base-gray-darker-catalog)] text-center">
          Czy na pewno chcesz zarezerwować?
        </h3>
        <p class="text-base font-medium text-[color:var(--base-gray-darker-catalog)] mb-2 text-center">
          „{{ data.bookTitle }}"
        </p>
        <p class="text-sm text-[color:var(--base-gray-darker-catalog)] mb-4">
          {{ getSelectedBranchName() }}
        </p>
        <p class="text-xs text-[color:var(--placeholder-gray-black)] mb-6">
          Rezerwacja jest ważna przez 2 dni od momentu utworzenia.
        </p>

        @if (errorMessage()) {
          <p class="text-sm text-[color:var(--red-600-to-black)] mb-4 text-center">{{ errorMessage() }}</p>
        }

        <div class="flex justify-center gap-3">
          <button
            mat-stroked-button
            (click)="onCancelConfirmation()"
            class="!px-6 !py-2 !font-medium !rounded-md cursor-pointer !border !border-[color:var(--edit-button-bg)] !text-[color:var(--edit-button-bg)]"
          >
            ANULUJ
          </button>
          <button
            mat-flat-button
            (click)="onConfirmReservation()"
            class="!px-6 !py-2 !font-medium !rounded-md cursor-pointer !bg-[color:var(--edit-button-bg)] !text-[color:var(--white-to-yellow)]"
          >
            TAK, REZERWUJĘ
          </button>
        </div>
      }
    </div>
  } @else {
    <div class="flex justify-between items-start mb-2">
      <h2 class="pt-2 m-0 text-2xl font-semibold text-[color:var(--base-btn-secondary-bg)]">
        {{ dialogTitle }}
      </h2>
      <button
        (click)="onCancel()"
        aria-label="Zamknij okno"
        class="p-2 -mr-2 -mt-2 rounded-lg bg-[color:var(--white-to-dark-gray)] focus:outline-none cursor-pointer transition duration-200"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="currentColor"
          class="w-6 h-6 text-[color:var(--gray-to-yellow)] hover:text-[color:var(--base-gray-darker-catalog)] transition"
        >
          <path
            fill-rule="evenodd"
            d="M5.47 5.47a.75.75 0 0 1 1.06 0L12 10.94l5.47-5.47a.75.75 0 1 1 1.06 1.06L13.06 12l5.47 5.47a.75.75 0 1 1-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 0 1-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 0 1 0-1.06Z"
            clip-rule="evenodd"
          />
        </svg>
      </button>
    </div>

    <div class="pb-5 pe-60">
      <hr class="border-[color:var(--base-gray-light)]"/>
    </div>

    <p class="text-[color:var(--base-gray-darker-catalog)] mb-5 text-[0.95rem]">
      {{ dialogSubtitle }}
    </p>

    <div class="mb-5">
      <mat-form-field
        appearance="outline"
        class="w-full"
        style="
          --mdc-outlined-text-field-focus-outline-color: var(--base-gray-darker-catalog);
          --mdc-outlined-text-field-hover-outline-color: var(--base-gray-darker-catalog);
          --mdc-outlined-text-field-focus-label-text-color: var(--base-gray-darker-catalog);
        "
      >
        <mat-icon matPrefix class="text-[color:var(--base-gray-darker-catalog)]">search</mat-icon>
        <input
          matInput
          placeholder="Wyszukaj: miasto, adres, filia..."
          [value]="searchQuery()"
          (input)="onSearchChange($event)"
        />
      </mat-form-field>
    </div>

    <div class="flex flex-col md:flex-row gap-6 mb-6">
      <div class="flex-1 min-w-0">
        <h3 class="mb-3 text-base font-medium text-[color:var(--base-gray-darker-catalog)]">
          Lokalizacja na mapie:
        </h3>
        <div
          #mapContainer
          class="h-[200px] md:h-[280px] rounded-lg border border-[color:var(--base-input-bg)] overflow-hidden"
        ></div>
        <p class="mt-2 text-sm text-[color:var(--placeholder-gray)] italic">
          Kliknij na pinezkę, aby wybrać filię
        </p>
      </div>

      <div class="flex-1 min-w-0 flex flex-col">
        <h3 class="mb-3 text-base font-medium text-[color:var(--base-gray-darker-catalog)]">
          Wybór z listy:
        </h3>
        <div
          #branchListContainer
          class="max-h-[200px] md:max-h-[300px] overflow-y-auto border border-[color:var(--branch-border)] rounded-lg custom-scrollbar"
          role="listbox"
        >
          @for (branch of filteredBranches(); track branch.id) {
            <div
              [id]="'branch-item-' + branch.id"
              (click)="selectBranch(branch)"
              (keydown.enter)="selectBranch(branch)"
              (keydown.space)="selectBranch(branch)"
              tabindex="0"
              role="option"
              [attr.aria-selected]="isBranchSelected(branch)"
              class="p-3 px-4 border-b border-[color:var(--branch-border)] cursor-pointer transition-colors duration-200 last:border-b-0 hover:bg-[color:var(--branch-hover)]"
              [class.bg-[color:var(--branch-background-color)]]="isBranchSelected(branch)"
              [class.border-l-[3px]]="isBranchSelected(branch)"
              [class.border-l-[color:var(--branch-border-left)]]="isBranchSelected(branch)"
            >
              <mat-radio-button
                class="w-full pointer-events-none custom-branch-radio"
                [checked]="isBranchSelected(branch)"
              >
                <div class="flex flex-col gap-[2px] ml-2">
                  <span class="font-semibold text-[0.95rem] text-[color:var(--branch-border-left)]">
                    {{ getBranchDisplayName(branch) }}
                  </span>
                  <span class="text-[0.85rem] text-[color:var(--base-gray-darker-catalog)]">
                    {{ branch.address }}, {{ branch.city }}
                  </span>
                </div>
              </mat-radio-button>
            </div>
          } @empty {
            <p class="p-6 text-center text-[color:var(--base-gray-darker-catalog)]">
              Nie znaleziono filii spełniających kryteria wyszukiwania.
            </p>
          }
        </div>
      </div>
    </div>

    <div class="flex justify-end gap-3">
      <button
        mat-stroked-button
        (click)="onCancel()"
        class="!min-w-[140px] !px-4 !py-2 !font-medium !rounded-md !transition-all !duration-150 cursor-pointer !bg-[color:var(--white-to-yellow)] !border !border-[color:var(--edit-button-bg)] !text-[color:var(--edit-button-bg)] hover:!bg-[color:var(--light-gray-to-light-yellow)]"
      >
        ANULUJ
      </button>
      <button
        mat-flat-button
        [disabled]="!selectedBranchId()"
        (click)="onConfirm()"
        class="!min-w-[140px] !px-4 !py-2 !font-medium !rounded-md !transition-all !duration-150 cursor-pointer !bg-[color:var(--edit-button-bg)] hover:!bg-[color:var(--blue-hover)] !text-[color:var(--white-to-yellow)] disabled:!bg-black/10 disabled:!text-black/40 disabled:!cursor-not-allowed"
      >
        {{ confirmButtonText }}
      </button>
    </div>
  }
</div>


